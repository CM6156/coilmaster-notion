# 텔레그램 자동 알림 문제해결 가이드

## 🤔 자동 알림이 작동하지 않는 이유

### 1. **브라우저 기반 타이머의 한계**
기존 시스템은 브라우저에서 `setInterval`을 사용하여 알림을 처리했습니다. 이는 다음과 같은 문제가 있습니다:

- ❌ **브라우저가 닫혀있으면 동작하지 않음**
- ❌ **탭이 비활성화되면 성능 제한**
- ❌ **사용자가 웹사이트에 접속해야만 동작**
- ❌ **컴퓨터가 꺼져있으면 알림 없음**

### 2. **새로운 해결책: Web Worker 기반 스케줄러**
새로운 시스템에서는 Web Worker를 사용하여 백그라운드에서 알림을 처리합니다:

- ✅ **브라우저 탭이 비활성화되어도 동작**
- ✅ **더 안정적인 타이머 동작**
- ✅ **메인 스레드 차단 없이 실행**

## 🔧 자동 알림 설정 확인

### 1. **필수 설정 체크리스트**

#### ✅ 봇 토큰 설정
```env
# .env 파일에 봇 토큰 추가
VITE_TELEGRAM_BOT_TOKEN=7904123264:AAFe7T54dRKNv-c64sHMDpBWKZIhtYq9ZD8
```

#### ✅ 텔레그램 알림 활성화
- 외부 알림 관리 → 텔레그램 → **"텔레그램 알림 활성화"** 스위치 ON
- 또는 텔레그램 알림 메뉴 → 설정 → **"알림 활성화"** 스위치 ON

#### ✅ 그룹 채팅 ID 설정
- 텔레그램 그룹에 봇 추가
- 그룹 채팅 ID 확인 (음수, 보통 -100으로 시작)
- 외부 알림 관리에서 "그룹 채팅 ID" 입력

#### ✅ 알림 시간 설정
- **알림 시간**: 하루 중 알림을 보낼 시간 (기본: 오전 9시)
- **체크 간격**: 마감일 체크 주기 (기본: 1시간)

#### ✅ 자동 알림 옵션
- **자동 알림**: 마감일 기반 자동 알림 활성화 ✅
- **주말 알림**: 필요에 따라 설정
- **사용자 멘션**: 그룹에서 담당자 태그 활성화

### 2. **알림 조건**
자동 알림은 다음 조건을 만족하는 항목들에 대해 발송됩니다:

#### 📁 **프로젝트**
- 마감일이 3일 이하로 남은 프로젝트
- 마감일이 지난 프로젝트
- 상태가 '완료'가 아닌 프로젝트

#### 📋 **업무**
- 마감일이 3일 이하로 남은 업무
- 마감일이 지난 업무
- 상태가 '완료'가 아닌 업무

## 🔍 문제 진단

### 1. **봇 상태 확인**
```
텔레그램 알림 → 개요 탭 → 봇 상태
```
- ✅ **활성**: 봇이 정상 작동
- ❌ **오류**: 봇 토큰 또는 설정 문제
- ⏳ **확인 중**: 상태 확인 진행 중

### 2. **알림 대상 확인**
```
텔레그램 알림 → 개요 탭 → 알림 대상
```
- 마감일이 임박한 프로젝트/업무 개수 확인
- 0개라면 현재 알림을 보낼 항목이 없음

### 3. **테스트 메시지 발송**
```
텔레그램 알림 → 테스트 탭 → 테스트 메시지 발송
```
- 채팅 ID 입력 후 테스트 메시지 발송
- 성공하면 봇과 채팅 ID 설정이 올바름

### 4. **즉시 알림 발송**
```
텔레그램 알림 → 개요 탭 → 즉시 알림 발송
```
- 수동으로 알림 발송 테스트
- 성공하면 설정이 올바름

## 🚨 자주 발생하는 문제들

### 1. **봇이 응답하지 않는 경우**

#### 원인:
- 잘못된 봇 토큰
- 봇이 차단됨
- 인터넷 연결 문제

#### 해결방법:
1. BotFather에서 새 봇 토큰 확인
2. 봇과 개인 대화 시작 (`/start` 명령)
3. 브라우저 개발자 도구에서 네트워크 오류 확인

### 2. **그룹에서 메시지가 전송되지 않는 경우**

#### 원인:
- 봇이 그룹에 없음
- 봇에게 메시지 전송 권한 없음
- 잘못된 그룹 채팅 ID

#### 해결방법:
1. 그룹에 봇 추가 확인
2. 봇을 관리자로 추가하고 "메시지 전송" 권한 부여
3. getUpdates API로 올바른 채팅 ID 확인:
   ```
   https://api.telegram.org/bot[BOT_TOKEN]/getUpdates
   ```

### 3. **설정된 시간에 알림이 오지 않는 경우**

#### 브라우저 관련:
- ✅ **브라우저 탭을 열어둔 상태 유지**
- ✅ **전력 절약 모드 비활성화**
- ✅ **브라우저가 백그라운드에서 실행되도록 설정**

#### 시간 설정:
- 알림 시간이 올바른지 확인 (24시간 형식)
- 체크 간격이 너무 길지 않은지 확인
- 주말 알림 설정 확인

### 4. **중복 알림이 발송되는 경우**

#### 원인:
- 여러 브라우저 탭에서 동시 실행
- 설정이 중복 저장됨

#### 해결방법:
1. 하나의 탭에서만 시스템 사용
2. localStorage 초기화:
   ```javascript
   localStorage.removeItem('telegram_last_sent');
   localStorage.removeItem('telegram_settings');
   ```

## 🛠️ 고급 설정

### 1. **알림 조건 커스터마이징**
현재는 3일 이하 마감일에 대해 알림을 보냅니다. 이를 변경하려면:

```typescript
// src/services/telegramScheduler.ts
if (daysLeft <= 3) { // 이 값을 변경
```

### 2. **알림 메시지 템플릿 수정**
메시지 형식을 변경하려면:

```typescript
// src/services/telegramScheduler.ts
private generateNotificationMessage(items: any[]): string {
  // 메시지 템플릿 수정
}
```

### 3. **알림 발송 로그 확인**
브라우저 개발자 도구 → Console에서 로그 확인:

```
스케줄러에서 알림 체크 요청: 2024-12-23T...
텔레그램 알림 발송 성공
자동 알림이 발송되었습니다: [...]
```

## 💡 최적화 팁

### 1. **서버 사이드 스케줄러 구축**
진정한 24/7 자동 알림을 위해서는 서버 사이드 스케줄러가 필요합니다:

- **Node.js Cron**: `node-cron` 사용
- **PM2**: 프로세스 관리자로 안정성 확보
- **Docker**: 컨테이너화로 배포 편의성
- **웹훅**: Telegram Bot API 웹훅 활용

### 2. **데이터베이스 알림 큐**
대규모 시스템에서는 알림 큐 시스템 구축:

- **Redis**: 알림 큐 관리
- **Bull Queue**: 작업 스케줄링
- **MongoDB**: 알림 히스토리 저장

### 3. **모니터링 시스템**
알림 시스템 모니터링:

- **Prometheus**: 메트릭 수집
- **Grafana**: 대시보드 구성
- **AlertManager**: 시스템 장애 알림

## 📞 지원

### 1. **로그 수집**
문제 발생 시 다음 정보를 수집해주세요:

- 브라우저 개발자 도구 Console 로그
- 네트워크 탭의 API 요청/응답
- localStorage의 설정 정보
- 시스템 환경 (OS, 브라우저 버전)

### 2. **문제 보고**
GitHub Issues 또는 시스템 관리자에게 다음 정보와 함께 보고:

- 발생 시간
- 예상 동작 vs 실제 동작
- 재현 단계
- 오류 메시지 (있는 경우)

---

## 📋 체크리스트

알림이 작동하지 않을 때 다음을 순서대로 확인하세요:

- [ ] 봇 토큰이 올바른지 확인
- [ ] 텔레그램 알림 활성화 확인
- [ ] 그룹 채팅 ID 설정 확인
- [ ] 봇이 그룹에 추가되고 권한이 있는지 확인
- [ ] 알림 시간과 체크 간격 설정 확인
- [ ] 자동 알림 옵션이 활성화되어 있는지 확인
- [ ] 테스트 메시지 발송 성공 여부 확인
- [ ] 즉시 알림 발송 테스트
- [ ] 브라우저 탭이 열려있는지 확인
- [ ] 알림 대상 항목이 있는지 확인 (마감일 3일 이하)
- [ ] 브라우저 Console에서 오류 메시지 확인

모든 설정이 올바른데도 알림이 작동하지 않는다면, 서버 사이드 스케줄러 구축을 고려해보세요! 